title: HBASE基础
date: 2016-05-13 17:35:11
updated: 2016-05-13 17:35:13
comments:
tags:
- hbase
categories:
- 

---

## HBASE

HBASE经常被称作无模式数据库。

HBASE是BigTable基于Hadoop的实现，目前HBASE主要应用在三种场景：

+ 增量数据
+ 内容服务（短链接、用户生产内容）
+ 信息交换（信息交换历史记录）

其实后两者本质上也是“增量数据”

## 部署

用于测试建议使用单机部署，伪分布式部署可能会因为zookeeper不存在而报错。

## HBASE和Cassandra区别

Hbase更加适合于数据仓库、大型数据的处理和分析（如进行Web页面的索引等），而Cassandra则更适合于实时事务处理和提供交互型数据

Cassandra做的还不够好的一件事情就是MapReduce！对于不精通此项技术同学简单的解释一句，这是一个用于并行处理大量数据的系统，比如从上百万从网络上抓取的页面提取统计信息。MapReduce和相关系统，比如Pig和Hive可以和HBase一起良好协作，因为它使用HDFS来存储数据，这些系统也是设计用来使用HDFS的。如果你需要进行这样的数据处理和分析的话，HBase可能是你目前的最佳选择。

## HBASE查询模式

HBase的查询实现只提供两种方式：

+ 按指定RowKey获取唯一一条记录，get方法（org.apache.hadoop.hbase.client.Get）
+ 按指定的条件获取一批记录，scan方法（org.apache.hadoop.hbase.client.Scan）


实现条件查询功能使用的就是scan方式，scan在使用时有以下几点值得注意：

+ scan可以通过setCaching与setBatch方法提高速度（以空间换时间）；
+ scan可以通过setStartRow与setEndRow来限定范围。范围越小，性能越高。
  通过巧妙的RowKey设计使我们批量获取记录集合中的元素挨在一起（应该在同一个Region下），可以在遍历结果时获得很好的性能。
+ scan可以通过setFilter方法添加过滤器，这也是分页、多条件查询的基础。

HBase没有Query命令，查找某个特定值的记录的唯一办法，是使用扫描Scan命令读出表的某些部分，然后再使用过滤器Filter来得到有关记录。

### HBase基本命令

HBase提供了5个基本命令，Get、Put、Delete、Scan、Increment。基于非行键值查询HBase的唯一方式是带过滤器的扫描。


> HBase中所有数据都是作为原始数据（raw data）使用字节数组的形式存储的。

HBase增加了随机存取层，是HDFS缺失的部分，是对Hadoop的理想补充。

HBase用于开发的安装建议使用单机部署，如果使用伪分布式部署，每次启动或运行shell时会报出zookeeper相关的错误

HBase使用表作为顶级结构来存储数据，写数据到HBase，就是写数据到表。

HBase使用put存储数据，使用get、scan读取数据。

HBase可以存储每个数据单元的多个时间版本，默认版本数3个。




### HBase数据模型

+ 表（table）
  HBase用表来组织数据，表名是字符串。
+ 行（row）
  在表里，数据按照行存储。行由行键唯一标识，行键没有数据类型。
+ 列族（column family）
  行里的数据按照列族分组。影响到HBase的物理存放，必须在事前定义，并且不轻易修改。表中每行拥有相同的列族，行不必在每个列族里存放数据，列族的名称也是字符串。
+ 列限定符（column qualifier）
  列族里的数据通过列限定符或列来定位。列限定符不必事先定义，列限定符不必在不同行之间保持一致，列限定符没有数据类型，用字符串表示。
+ 单元（cell）
  行键、列族和列限定符一起确定一个单元，单元里存储的值成为单元值，没有数据类型。
+ 时间版本（version）
  单元值有时间版本，用时间戳标识。

> HBase = 无模式数据库，半结构化数据库
> HBase不能实施关系约束，不支持多行事务

过滤器可以应用到行键、列限定符和单元值（不包括列族），可以组合使用多个过滤器，过滤器允许对数据分页进行处理，限制扫描器返回的行数等等。

列值递增（原子操作）？
单行操作是原子性的，给定行的多个写操作，总是以每个写操作为整体彼此独立的。
行间操作不是原子性的。

HBase是一种专门为半结构化数据和水平可扩展性设计的数据库，是无模式数据库，也是无类型数据库，把所有数据不加解释地按照字节数组（Byte[]）存储。有5个基本命令用来访问HBase中的数据，即Get、Put、Delete、Scan和Increment。基于非行键值查询HBase的唯一办法是通过带过滤器的扫描。


### 工作机制

#### HBase写路径

HBase执行写入时会写到两个地方：预写式日志（write-ahead log ~ WAL）和MemStore。

MemStore是内存里的写入缓存区，HBase数据在永久写入硬盘之前在此累积，当其填满后，会写入硬盘生成一个HFile。HFile对应于列族，一个列族可以有多个HFile，但一个HFile不能存储多个列族的数据。

HBase服务器宕机时，没有从MemStore写入HFile的数据，将可以通过回放WAL来恢复，该过程无需手工执行。

#### HBase读路径

HBase读动作必须重新衔接持久化到硬盘上HFile和内存MemStore中的数据。HBase在读操作上使用了LRU缓存技术，也被叫做BlockCache，和MemStore在一个JVM堆里。BlockCache设计用来保存从HFile里读入内存的频繁访问的数据，每个列族都有自己的BlockCache。

HFile的物理存放是一个Block的序列+这些Block的索引，Block是建立索引的最小数据单位，也是从硬盘读取的最小数据单位。

从HBase中读取一行，首先会检查MemStore等待修改的队列，然后检查BlockCache看包含该行的Block是否最近被访问过，最后访问硬盘上对于的HFile。由于一个HFile只能存放一个列族的数据，因此为了获取一个完整行的数据，HBase可能需要读取多个HFile。

#### HBase删除

删除动作和写入动作相同，但是不会立即删除，只是做上标记，HBase后台会在合适的时候对HFile进行合并，此时才会真正删除。

#### HBase数据坐标

HBase使用行键、列族、列限定符和时间版本定位一个单元，读取数据时，可以输入[行键]、[行键+列族]、[行键+列族+列限定符]、[行键+列族+列限定符+时间版本]，将分别获取指定范围的数据。单元坐标的维度越少，对应值的集合范围越广。



### 行键设计

预期的数据访问模式对HBase的模式设计有很大的影响。在理想情况下，HBase中的表根据预期的模式来组织。行键是HBase中唯一的全局索引坐标，因此查询经常通过行键扫描实现。复合行键是支持这种扫描的常见做法。行键值经常希望是均衡分布的，通常采用MD5或SHA1等散列算法来实现。

#### 案例一

行键设计：md5(用户名)+时间戳

优点：行键的第一部分使用md5(用户名)的形式，使得用户数据以自然行的顺序有效地生成数据捅（bucket），即来自同一用户的数据以连续行的形式存储在一起。